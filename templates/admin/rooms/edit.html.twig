{% extends 'admin/_layout.html.twig' %}

{% block title %}Éditer une salle{% endblock %}

{% set active_menu = 'salles_catalogue' %}
{% set page_heading = 'Éditer une salle' %}

{% block admin_breadcrumb %}
    <div class="mb-4">
        {% include 'admin/rooms/_breadcrumb.html.twig' with { current_label: page_heading } %}
    </div>
{% endblock %}

{% block admin_content %}
    <div class="mb-8 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
            <p class="text-xs font-semibold uppercase tracking-[0.18em] text-brand">Catalogue</p>
            <h1 class="mt-3 text-3xl font-semibold text-heading">{{ page_heading }}</h1>
            <p class="mt-2 max-w-2xl text-sm text-body">Modifiez les informations de la salle.</p>
        </div>
        <div class="flex flex-wrap gap-3">
            {{ include('components/_button.html.twig', {
                label: 'Retour à la liste',
                href: path('app_admin_rooms_index'),
                variant: 'tertiary',
                size: 'sm'
            }) }}
        </div>
    </div>

    <section class="rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        {% set name_required_message = 'room.name.required'|trans({}, 'validators') %}
        {% set venue_required_message = 'room.venue.required'|trans({}, 'validators') %}

        {{ form_start(form, { attr: { class: 'grid gap-6 md:grid-cols-4', novalidate: 'novalidate', 'data-validate-form': 'true' } }) }}
            <div class="md:col-span-4">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-body">Informations générales</p>
            </div>
            {{ include('components/_form_field.html.twig', {
                field: form.venue,
                wrapper_class: 'md:col-span-2',
                required_message: venue_required_message
            }) }}
            {{ include('components/_form_field.html.twig', {
                field: form.name,
                wrapper_class: 'md:col-span-2',
                required_message: name_required_message
            }) }}
            {{ include('components/_form_field.html.twig', {
                field: form.description,
                wrapper_class: 'md:col-span-4'
            }) }}

            <div class="md:col-span-4 border-t border-default pt-4">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-body">Typologies</p>
            </div>
            <div class="md:col-span-2">
                {% set types_has_error = form.roomTypes.vars.errors|length > 0 %}
                {{ form_label(form.roomTypes, null, { label_attr: {
                    class: 'mb-3 block text-sm font-medium ' ~ (types_has_error ? 'text-danger dark:text-fg-danger-strong' : 'text-heading')
                } }) }}
                <div class="grid gap-3 sm:grid-cols-2">
                    {{ form_widget(form.roomTypes, { attr: { class: 'space-y-2' } }) }}
                </div>
                <div id="{{ form.roomTypes.vars.id }}-error" class="mt-2 text-xs text-danger dark:text-fg-danger-strong{% if not types_has_error %} hidden{% endif %}">
                    {{ form_errors(form.roomTypes) }}
                </div>
            </div>
            <div class="md:col-span-2">
                {% set layouts_has_error = form.roomLayouts.vars.errors|length > 0 %}
                {{ form_label(form.roomLayouts, null, { label_attr: {
                    class: 'mb-3 block text-sm font-medium ' ~ (layouts_has_error ? 'text-danger dark:text-fg-danger-strong' : 'text-heading')
                } }) }}
                <div class="grid gap-3 sm:grid-cols-2">
                    {{ form_widget(form.roomLayouts, { attr: { class: 'space-y-2' } }) }}
                </div>
                <div id="{{ form.roomLayouts.vars.id }}-error" class="mt-2 text-xs text-danger dark:text-fg-danger-strong{% if not layouts_has_error %} hidden{% endif %}">
                    {{ form_errors(form.roomLayouts) }}
                </div>
            </div>

            <div class="md:col-span-4 border-t border-default pt-4">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-body">Capacités et surface</p>
            </div>
            {{ include('components/_form_field.html.twig', { field: form.surfaceArea, wrapper_class: 'md:col-span-2' }) }}
            {{ include('components/_form_field.html.twig', { field: form.seatedCapacity, wrapper_class: 'md:col-span-1' }) }}
            {{ include('components/_form_field.html.twig', { field: form.standingCapacity, wrapper_class: 'md:col-span-1' }) }}

            <div class="md:col-span-4 border-t border-default pt-4">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-body">Accessibilité et sécurité</p>
            </div>
            <div class="md:col-span-4 grid gap-4 sm:grid-cols-2">
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.isPmrAccessible }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.hasElevator }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.hasPmrRestrooms }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.hasEmergencyExits }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.isErpCompliant }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.securityStaffRequired }) }}
            </div>
            {{ include('components/_form_field.html.twig', { field: form.erpType, wrapper_class: 'md:col-span-2' }) }}
            {{ include('components/_form_field.html.twig', { field: form.erpCategory, wrapper_class: 'md:col-span-2' }) }}

            <div class="md:col-span-4 border-t border-default pt-4">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-body">Règlement et usage</p>
            </div>
            {{ include('components/_form_field.html.twig', { field: form.openingHoursSchema, wrapper_class: 'md:col-span-4' }) }}
            {{ include('components/_form_field.html.twig', { field: form.minRentalDurationMinutes, wrapper_class: 'md:col-span-1' }) }}
            {{ include('components/_form_field.html.twig', { field: form.maxRentalDurationMinutes, wrapper_class: 'md:col-span-1' }) }}
            {{ include('components/_form_field.html.twig', { field: form.bookingLeadTimeDays, wrapper_class: 'md:col-span-1' }) }}
            <div class="md:col-span-4 grid gap-4 sm:grid-cols-2">
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.cateringAllowed }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.alcoholAllowed }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.musicAllowed }) }}
                {{ include('admin/rooms/_checkbox_field.html.twig', { field: form.sacemRequired }) }}
            </div>
            {{ include('components/_form_field.html.twig', { field: form.alcoholLegalNotice, wrapper_class: 'md:col-span-4' }) }}

            <div class="md:col-span-4 flex items-center justify-end gap-3">
                {{ include('components/_button.html.twig', {
                    label: 'Annuler',
                    href: path('app_admin_rooms_show', { publicIdentifier: room.publicIdentifier }),
                    variant: 'tertiary',
                    size: 'sm'
                }) }}
                {{ include('components/_button.html.twig', {
                    label: 'Enregistrer',
                    variant: 'primary',
                    size: 'sm',
                    type: 'submit',
                    extra_class: 'min-w-[160px]'
                }) }}
            </div>
        {{ form_end(form) }}
    </section>

    <section class="mt-6 rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-body">Photos</h2>
                <p class="mt-2 text-sm text-body">Ajoutez des photos qui seront visibles dans l’interface utilisateur.</p>
            </div>
        </div>
        <div class="mt-4 grid gap-6">
            <div class="rounded-base border border-default bg-neutral-primary p-4" data-photo-dropzone data-upload-url="{{ path('app_admin_rooms_photo_upload', { publicIdentifier: room.publicIdentifier }) }}" data-csrf-token="{{ csrf_token('upload_room_photo_' ~ room.publicIdentifier) }}" data-gallery-target="room-photo-gallery" data-photo-modal-prefix="room-photo-preview" data-photo-delete-modal="room-photo-delete-modal">
                {{ form_start(photo_form, { attr: { class: 'grid gap-4', novalidate: 'novalidate', 'data-validate-form': 'true' } }) }}
                    <label for="room-photo-input" role="button" tabindex="0" class="flex cursor-pointer flex-col items-center justify-center rounded-base border-2 border-dashed border-default bg-neutral-primary-soft px-6 py-8 text-center hover:bg-neutral-secondary-soft" data-photo-dropzone-label>
                        <svg class="mb-4 h-10 w-10 text-body" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                        </svg>
                        <p class="mb-2 text-sm font-semibold text-heading"><span class="font-semibold">Cliquez pour téléverser</span> ou glissez-déposez</p>
                        <p class="text-xs text-body" data-photo-status>JPG, PNG, WEBP · 2 Mo max</p>
                        {{ form_widget(photo_form.photo, { attr: { id: 'room-photo-input', class: 'sr-only', 'data-photo-input': 'true' } }) }}
                    </label>
                    <div class="text-xs text-danger" data-photo-error>
                        {{ form_errors(photo_form.photo) }}
                    </div>
                    <div class="flex items-center justify-end" data-photo-submit>
                        {{ include('components/_button.html.twig', {
                            label: 'Ajouter les photos',
                            variant: 'primary',
                            size: 'sm',
                            type: 'submit'
                        }) }}
                    </div>
                {{ form_end(photo_form) }}
            </div>
            <div class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4" id="room-photo-gallery">
                {% for photo in room_photos %}
                    <div class="group overflow-hidden rounded-base border border-default bg-neutral-primary shadow-xs" data-photo-id="{{ photo.id }}">
                        <div class="relative aspect-[4/3] overflow-hidden bg-neutral-secondary-medium">
                            <img src="{{ asset(photo.filePath) }}" alt="{{ photo.label }}" class="h-full w-full object-cover" loading="lazy">
                            <div class="absolute inset-0 flex items-center justify-center gap-2 bg-dark/40 opacity-0 transition-opacity group-hover:opacity-100">
                                <button type="button" class="rounded-base bg-neutral-primary px-3 py-1.5 text-xs font-medium text-heading shadow-xs" data-modal-target="room-photo-preview-{{ photo.id }}" data-modal-toggle="room-photo-preview-{{ photo.id }}">
                                    Aperçu
                                </button>
                                <button type="button" class="rounded-base bg-danger px-3 py-1.5 text-xs font-medium text-white shadow-xs" data-modal-target="room-photo-delete-modal" data-modal-toggle="room-photo-delete-modal" data-delete-url="{{ path('app_admin_rooms_photo_delete', { publicIdentifier: room.publicIdentifier, photoId: photo.id }) }}" data-delete-token="{{ csrf_token('delete_room_photo_' ~ photo.id) }}" data-delete-name="{{ photo.label }}">
                                    Supprimer
                                </button>
                            </div>
                        </div>
                        <div class="p-3" data-photo-label-card data-update-url="{{ path('app_admin_rooms_photo_label_update', { publicIdentifier: room.publicIdentifier, photoId: photo.id }) }}" data-csrf-token="{{ csrf_token('update_room_photo_label_' ~ photo.id) }}">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0 flex-1">
                                    <p class="text-sm font-medium text-heading break-words" data-photo-label-text>{{ photo.label ?: 'Photo' }}</p>
                                    <p class="text-xs text-body-subtle">{{ photo.createdAt|date('d/m/Y') }}</p>
                                </div>
                                <button type="button" class="shrink-0 text-xs text-body-subtle hover:text-heading" data-photo-label-edit>Renommer</button>
                            </div>
                            <div class="mt-2 hidden" data-photo-label-form>
                                <input type="text" class="w-full rounded-base border border-default bg-neutral-primary px-3 py-2 text-xs text-heading" value="{{ photo.label ?: 'Photo' }}" data-photo-label-input>
                                <div class="mt-2 flex items-center gap-2">
                                    <button type="button" class="rounded-base bg-brand-strong px-3 py-1.5 text-xs font-medium text-white" data-photo-label-save>Enregistrer</button>
                                    <button type="button" class="rounded-base border border-default bg-neutral-primary px-3 py-1.5 text-xs font-medium text-body" data-photo-label-cancel>Annuler</button>
                                </div>
                                <p class="mt-2 text-xs text-danger hidden" data-photo-label-error></p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-body-subtle" data-photo-empty>Aucune photo disponible.</p>
                {% endfor %}
                <label for="room-photo-input" class="flex cursor-pointer items-center justify-center rounded-base border border-dashed border-default bg-neutral-primary-soft text-sm text-body hover:bg-neutral-secondary-soft" data-photo-add-tile>
                    +
                </label>
            </div>
        </div>
    </section>

    {% include 'admin/_partials/_delete_modal.html.twig' with {
        modal_id: 'room-photo-delete-modal',
        message: 'Confirmez la suppression de cette photo ?',
        confirm_label: 'Oui, supprimer',
        cancel_label: 'Annuler',
        csrf_token_id: 'delete_room_photo',
        show_name: true
    } %}

    {% for photo in room_photos %}
        <div id="room-photo-preview-{{ photo.id }}" tabindex="-1" class="hidden fixed left-0 right-0 top-0 z-50 h-[calc(100%-1rem)] max-h-full w-full items-center justify-center overflow-y-auto overflow-x-hidden md:inset-0">
            <div class="relative w-full max-w-4xl p-4">
                <div class="relative rounded-base border border-default bg-neutral-primary-soft p-4 shadow-sm md:p-6">
                    <button type="button" class="absolute end-2.5 top-3 inline-flex h-9 w-9 items-center justify-center rounded-base bg-transparent text-sm text-body hover:bg-neutral-tertiary hover:text-heading" data-modal-hide="room-photo-preview-{{ photo.id }}">
                        <span class="sr-only">Fermer</span>
                        <svg class="h-5 w-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
                        </svg>
                    </button>
                    <div class="flex flex-col gap-4">
                        <img src="{{ asset(photo.filePath) }}" alt="{{ photo.label }}" class="max-h-[70vh] w-full rounded-base object-contain">
                        <div>
                            <p class="text-sm font-medium text-heading" data-photo-label-modal="{{ photo.id }}">{{ photo.label ?: 'Photo' }}</p>
                            <p class="text-xs text-body-subtle">{{ photo.createdAt|date('d/m/Y') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}
