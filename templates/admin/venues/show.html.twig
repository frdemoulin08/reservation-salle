{% extends 'admin/_layout.html.twig' %}

{% block title %}Site de {{ venue.name }}{% endblock %}

{% set active_menu = 'sites' %}
{% set page_heading = venue.name %}

{% block admin_breadcrumb %}
    <div class="mb-4">
        {% include 'admin/venues/_breadcrumb.html.twig' with { current_label: page_heading } %}
    </div>
{% endblock %}

{% block admin_content %}
    <div class="mb-8 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
            <p class="text-xs font-semibold uppercase tracking-[0.18em] text-brand">Gestion</p>
            <h1 class="mt-3 text-3xl font-semibold text-heading">{{ page_heading }}</h1>
            <p class="mt-2 max-w-2xl text-sm text-body">Fiche détaillée du site.</p>
        </div>
        <div class="flex flex-wrap gap-3">
            {% if is_granted('ROLE_BUSINESS_ADMIN') %}
                {{ include('components/_button.html.twig', {
                    label: 'Éditer',
                    href: path('app_admin_venues_edit', { publicIdentifier: venue.publicIdentifier }),
                    variant: 'warning',
                    size: 'sm'
                }) }}
            {% endif %}
            {{ include('components/_button.html.twig', {
                label: 'Retour à la liste',
                href: path('app_admin_venues_index'),
                variant: 'tertiary',
                size: 'sm'
            }) }}
        </div>
    </div>

    <section class="rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-body">{{ 'venue.sections.general'|trans }}</h2>
        <dl class="mt-4 grid gap-4 sm:grid-cols-2">
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.name'|trans }}</dt>
                <dd class="mt-2 text-base font-semibold text-heading">{{ venue.name }}</dd>
            </div>
            <div class="sm:col-span-2">
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.reference_contact_user'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">
                    {% if venue.referenceContactUser %}
                        <p class="font-semibold text-heading">
                            {{ venue.referenceContactUser.firstname }} {{ venue.referenceContactUser.lastname }}
                        </p>
                        <p class="mt-1 text-sm text-body">{{ venue.referenceContactUser.email }}</p>
                        {% if venue.referenceContactUser.mobilePhone %}
                            <p class="text-sm text-body">Mobile : {{ venue.referenceContactUser.mobilePhone }}</p>
                        {% endif %}
                        {% if venue.referenceContactUser.fixedPhone %}
                            <p class="text-sm text-body">Fixe : {{ venue.referenceContactUser.fixedPhone }}</p>
                        {% endif %}
                        {% if not venue.referenceContactUser.mobilePhone and not venue.referenceContactUser.fixedPhone %}
                            <p class="text-sm text-body">Téléphone : —</p>
                        {% endif %}
                    {% else %}
                        —
                    {% endif %}
                </dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'common.updated_at'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.updatedAt|date('d/m/Y \\à H:i:s') }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'common.created_at'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.createdAt|date('d/m/Y \\à H:i:s') }}</dd>
            </div>
            <div class="sm:col-span-2">
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.description'|trans }}</dt>
                <dd class="mt-2 text-base text-heading whitespace-pre-line">{{ venue.description ?? '—' }}</dd>
            </div>
            <div class="sm:col-span-2">
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.house_rules'|trans }}</dt>
                <dd class="mt-2 text-base text-heading whitespace-pre-line">{{ venue.houseRules ?? '—' }}</dd>
            </div>
        </dl>
    </section>

    <section class="mt-6 rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-body">{{ 'venue.sections.address'|trans }}</h2>
        <dl class="mt-4 grid gap-4 sm:grid-cols-2">
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_line1'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.line1 ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_line2'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.line2 ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_line3'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.line3 ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_postal_code'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.postalCode ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_city'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.city ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_country'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">
                    {% if venue.address.country %}
                        {{ country_label ?? venue.address.country }}
                    {% else %}
                        —
                    {% endif %}
                </dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_source'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">
                    {% if venue.address.source %}
                        {% set source_label = ('venue.address_source.' ~ venue.address.source|lower)|trans %}
                        {{ source_label starts with 'venue.address_source.' ? venue.address.source : source_label }}
                    {% else %}
                        —
                    {% endif %}
                </dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_external_id'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.externalId ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_latitude'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.latitude ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.address_longitude'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.address.longitude ?? '—' }}</dd>
            </div>
        </dl>
    </section>

    <section class="mt-6 rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-body">{{ 'venue.sections.access'|trans }}</h2>
        <dl class="mt-4 grid gap-4 sm:grid-cols-2">
            <div class="sm:col-span-2">
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.public_transport_access'|trans }}</dt>
                <dd class="mt-2 text-base text-heading whitespace-pre-line">{{ venue.publicTransportAccess ?? '—' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.parking_type'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">
                    {{ venue.parkingType ? venue.parkingType|capitalize : '—' }}
                    {% if venue.parkingCapacity %}({{ venue.parkingCapacity }} {{ 'venue.fields.parking_capacity'|trans|lower }}){% endif %}
                </dd>
            </div>
            <div>
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.delivery_access'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">{{ venue.deliveryAccess ?? '—' }}</dd>
            </div>
            <div class="sm:col-span-2">
                <dt class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue.fields.access_map_url'|trans }}</dt>
                <dd class="mt-2 text-base text-heading">
                    {% if venue.accessMapUrl %}
                        <a class="font-medium text-brand hover:underline" href="{{ venue.accessMapUrl }}" target="_blank" rel="noopener noreferrer">
                            {{ venue.accessMapUrl }}
                        </a>
                    {% else %}
                        —
                    {% endif %}
                </dd>
            </div>
        </dl>
    </section>

    <section class="mt-6 rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-body">{{ 'venue.sections.photos'|trans }}</h2>
                <p class="mt-2 text-sm text-body">Ajoutez des photos qui seront visibles dans l’interface utilisateur.</p>
            </div>
        </div>
        <div class="mt-4 grid gap-6">
            <div class="rounded-base border border-default bg-neutral-primary p-4" data-photo-dropzone data-upload-url="{{ path('app_admin_venues_photo_upload', { publicIdentifier: venue.publicIdentifier }) }}" data-csrf-token="{{ csrf_token('upload_venue_photo_' ~ venue.publicIdentifier) }}" data-gallery-target="venue-photo-gallery">
                {{ form_start(photo_form, { attr: { class: 'grid gap-4', novalidate: 'novalidate', 'data-validate-form': 'true' } }) }}
                    <label for="venue-photo-input" role="button" tabindex="0" class="flex cursor-pointer flex-col items-center justify-center rounded-base border-2 border-dashed border-default bg-neutral-primary-soft px-6 py-8 text-center hover:bg-neutral-secondary-soft" data-photo-dropzone-label>
                        <svg class="mb-4 h-10 w-10 text-body" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                        </svg>
                        <p class="mb-2 text-sm font-semibold text-heading"><span class="font-semibold">Cliquez pour téléverser</span> ou glissez-déposez</p>
                        <p class="text-xs text-body" data-photo-status>JPG, PNG, WEBP · 5 Mo max</p>
                        {{ form_widget(photo_form.photo, { attr: { id: 'venue-photo-input', class: 'sr-only', 'data-photo-input': 'true' } }) }}
                    </label>
                    <div class="text-xs text-danger" data-photo-error>
                        {{ form_errors(photo_form.photo) }}
                    </div>
                    <div class="flex items-center justify-end" data-photo-submit>
                        {{ include('components/_button.html.twig', {
                            label: 'Ajouter les photos',
                            variant: 'primary',
                            size: 'sm',
                            type: 'submit'
                        }) }}
                    </div>
                {{ form_end(photo_form) }}
            </div>
            <div class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4" id="venue-photo-gallery">
                {% for photo in venue_photos %}
                    <div class="group overflow-hidden rounded-base border border-default bg-neutral-primary shadow-xs" data-photo-id="{{ photo.id }}">
                        <div class="relative aspect-[4/3] overflow-hidden bg-neutral-secondary-medium">
                            <img src="{{ asset(photo.filePath) }}" alt="{{ photo.label }}" class="h-full w-full object-cover" loading="lazy">
                            <div class="absolute inset-0 flex items-center justify-center gap-2 bg-dark/40 opacity-0 transition-opacity group-hover:opacity-100">
                                <button type="button" class="rounded-base bg-neutral-primary px-3 py-1.5 text-xs font-medium text-heading shadow-xs" data-modal-target="venue-photo-preview-{{ photo.id }}" data-modal-toggle="venue-photo-preview-{{ photo.id }}">
                                    Aperçu
                                </button>
                                <button type="button" class="rounded-base bg-danger px-3 py-1.5 text-xs font-medium text-white shadow-xs" data-modal-target="venue-photo-delete-modal" data-modal-toggle="venue-photo-delete-modal" data-delete-url="{{ path('app_admin_venues_photo_delete', { publicIdentifier: venue.publicIdentifier, id: photo.id }) }}" data-delete-token="{{ csrf_token('delete_venue_photo_' ~ photo.id) }}" data-delete-name="{{ photo.label }}">
                                    Supprimer
                                </button>
                            </div>
                        </div>
                        <div class="p-3" data-photo-label-card data-update-url="{{ path('app_admin_venues_photo_label_update', { publicIdentifier: venue.publicIdentifier, id: photo.id }) }}" data-csrf-token="{{ csrf_token('update_venue_photo_label_' ~ photo.id) }}">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-sm font-medium text-heading" data-photo-label-text>{{ photo.label ?: 'Photo' }}</p>
                                    <p class="text-xs text-body-subtle">{{ photo.createdAt|date('d/m/Y') }}</p>
                                </div>
                                <button type="button" class="text-xs text-body-subtle hover:text-heading" data-photo-label-edit>Renommer</button>
                            </div>
                            <div class="mt-2 hidden" data-photo-label-form>
                                <input type="text" class="w-full rounded-base border border-default bg-neutral-primary px-3 py-2 text-xs text-heading" value="{{ photo.label ?: 'Photo' }}" data-photo-label-input>
                                <div class="mt-2 flex items-center gap-2">
                                    <button type="button" class="rounded-base bg-brand-strong px-3 py-1.5 text-xs font-medium text-white" data-photo-label-save>Enregistrer</button>
                                    <button type="button" class="rounded-base border border-default bg-neutral-primary px-3 py-1.5 text-xs font-medium text-body" data-photo-label-cancel>Annuler</button>
                                </div>
                                <p class="mt-2 text-xs text-danger hidden" data-photo-label-error></p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-body-subtle" data-photo-empty>Aucune photo disponible.</p>
                {% endfor %}
                <label for="venue-photo-input" class="flex cursor-pointer items-center justify-center rounded-base border border-dashed border-default bg-neutral-primary-soft text-sm text-body hover:bg-neutral-secondary-soft" data-photo-add-tile>
                    +
                </label>
            </div>
        </div>
    </section>

    <section class="mt-6 rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-body">{{ 'venue.sections.documents'|trans }}</h2>
                <p class="mt-2 text-sm text-body">Ajoutez des documents publics ou privés associés au site.</p>
            </div>
        </div>
        <div class="mt-4 grid gap-6 lg:grid-cols-3">
            <div class="rounded-base border border-default bg-neutral-primary p-4">
                {{ form_start(document_form, { attr: { class: 'grid gap-4', novalidate: 'novalidate', 'data-validate-form': 'true' } }) }}
                    {{ include('components/_form_field.html.twig', {
                        field: document_form.documentType,
                        wrapper_class: ''
                    }) }}
                    {{ include('components/_form_field.html.twig', {
                        field: document_form.label,
                        wrapper_class: ''
                    }) }}
                    {{ include('components/_form_field.html.twig', {
                        field: document_form.file,
                        wrapper_class: ''
                    }) }}
                    <div class="flex items-center justify-end">
                        {{ include('components/_button.html.twig', {
                            label: 'Ajouter le document',
                            variant: 'primary',
                            size: 'sm',
                            type: 'submit'
                        }) }}
                    </div>
                {{ form_end(document_form) }}
            </div>
            <div class="lg:col-span-2">
                <ul class="space-y-3 text-sm text-heading">
                    {% for document in venue_documents %}
                        {% set is_public = document.isPublic %}
                        {% set document_label = document.label ?: 'Document' %}
                        {% set document_type_label = document.documentType ? document.documentType.label : '—' %}
                        {% set link = is_public ? asset(document.filePath) : path('app_admin_site_document_download', { id: document.id }) %}
                        <li class="flex flex-wrap items-center justify-between gap-3 rounded-base border border-default bg-neutral-primary px-4 py-3">
                            <div>
                                <a class="font-medium text-brand hover:underline" href="{{ link }}" target="_blank" rel="noopener noreferrer">
                                    {{ document_label }}
                                </a>
                                <div class="text-xs text-body-subtle">
                                    <span>{{ document_type_label }}</span>
                                    <span>·</span>
                                    <span>{{ is_public ? 'Public' : 'Privé' }}</span>
                                </div>
                            </div>
                            <button type="button" class="text-xs text-danger hover:text-danger-strong" data-modal-target="venue-document-delete-modal" data-modal-toggle="venue-document-delete-modal" data-delete-url="{{ path('app_admin_venues_document_delete', { publicIdentifier: venue.publicIdentifier, id: document.id }) }}" data-delete-token="{{ csrf_token('delete_venue_document_' ~ document.id) }}" data-delete-name="{{ document_label }}">
                                Supprimer
                            </button>
                        </li>
                    {% else %}
                        <li class="text-body-subtle">Aucun document disponible.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </section>

    <section class="mt-6 rounded-2xl border border-default bg-neutral-primary-soft p-6 shadow-xs">
        <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-body">{{ 'venue.sections.resources'|trans }}</h2>
        <div class="mt-4 grid gap-6 lg:grid-cols-2">
            <div class="rounded-base border border-default bg-neutral-primary p-4">
                <h3 class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'room.plural'|trans }}</h3>
                <ul class="mt-3 space-y-2 text-sm text-heading">
                    {% for room in venue.rooms %}
                        <li>
                            <a class="font-medium text-brand hover:underline" href="{{ path('app_admin_rooms_show', { id: room.id }) }}">
                                {{ room.name }}
                            </a>
                        </li>
                    {% else %}
                        <li class="text-body-subtle">—</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="rounded-base border border-default bg-neutral-primary p-4">
                <h3 class="text-xs font-semibold uppercase tracking-[0.12em] text-body">{{ 'venue_equipment.plural'|trans }}</h3>
                <ul class="mt-3 space-y-2 text-sm text-heading">
                    {% for equipment in venue.venueEquipments %}
                        <li>
                            {{ equipment.equipmentType.label }}
                            {% if equipment.maxQuantity %}
                                - {{ equipment.maxQuantity }} {{ 'venue_equipment.fields.max_quantity'|trans|lower }}
                            {% endif %}
                            {% if equipment.isIncluded %}
                                ({{ 'venue_equipment.values.included'|trans|lower }})
                            {% else %}
                                ({{ 'venue_equipment.values.optional'|trans|lower }})
                            {% endif %}
                        </li>
                    {% else %}
                        <li class="text-body-subtle">—</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </section>

    {% include 'admin/_partials/_delete_modal.html.twig' with {
        modal_id: 'venue-photo-delete-modal',
        message: 'Confirmez la suppression de cette photo ?',
        confirm_label: 'Oui, supprimer',
        cancel_label: 'Annuler',
        csrf_token_id: 'delete_venue_photo',
        show_name: true
    } %}

    {% include 'admin/_partials/_delete_modal.html.twig' with {
        modal_id: 'venue-document-delete-modal',
        message: 'Confirmez la suppression de ce document ?',
        confirm_label: 'Oui, supprimer',
        cancel_label: 'Annuler',
        csrf_token_id: 'delete_venue_document',
        show_name: true
    } %}

    {% for photo in venue_photos %}
        <div id="venue-photo-preview-{{ photo.id }}" tabindex="-1" class="hidden fixed left-0 right-0 top-0 z-50 h-[calc(100%-1rem)] max-h-full w-full items-center justify-center overflow-y-auto overflow-x-hidden md:inset-0">
            <div class="relative w-full max-w-4xl p-4">
                <div class="relative rounded-base border border-default bg-neutral-primary-soft p-4 shadow-sm md:p-6">
                    <button type="button" class="absolute end-2.5 top-3 inline-flex h-9 w-9 items-center justify-center rounded-base bg-transparent text-sm text-body hover:bg-neutral-tertiary hover:text-heading" data-modal-hide="venue-photo-preview-{{ photo.id }}">
                        <span class="sr-only">Fermer</span>
                        <svg class="h-5 w-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
                        </svg>
                    </button>
                    <div class="flex flex-col gap-4">
                        <img src="{{ asset(photo.filePath) }}" alt="{{ photo.label }}" class="max-h-[70vh] w-full rounded-base object-contain">
                        <div>
                            <p class="text-sm font-medium text-heading" data-photo-label-modal="{{ photo.id }}">{{ photo.label ?: 'Photo' }}</p>
                            <p class="text-xs text-body-subtle">{{ photo.createdAt|date('d/m/Y') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}
